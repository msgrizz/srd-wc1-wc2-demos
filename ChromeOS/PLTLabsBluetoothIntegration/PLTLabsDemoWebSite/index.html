<!DOCTYPE html>

<html>
<head>
    <title>Social Assist</title>
    <link rel="stylesheet" href="css/main.css">
    <script src="js/vendor/jquery-1.10.2.min.js"></script>
    <script src="js/vendor/jquery-ui-1.10.4.custom.min.js"></script>
    <script src="js/vendor/peer.js"></script>
    <script src="js/app.js"></script>
    <script src='https://maps.googleapis.com/maps/api/js?v=3.exp&sensor=false'></script>
    <script>
	//WebRTC variables
	var handleId;
	var serverIPAddress;
	var port = "8080";
	var connectionKey = "peerjs";

	// Compatibility shim
        navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia;
        var peer = null;
        var readyForCall = false;
        var ringing = false;
        var ringtone = new Audio('/media/ringtone.ogg');
        ringtone.addEventListener('ended', function() {this.currentTime = 0;if(ringing){this.play();}}); //loop for the ringtone

        var panorama;
	var map;
	
	function init(){
	    readyForCall = false;
	    $('#btnCall').attr("disabled", true);
	    $('#btnHangUp').attr("disabled", true);
	    $('#btnHangUp').click(hangUp);
	    $('#btnHangUp').hide();
	    $('#btnDisconnect').click(disconnectWebRTC)
	    $("input[name='server']").click(enableConnectToServerButton);
	    $('#btnConnect').click(function(){
		//
		$('#userHandle').attr("disabled", true);
                $('#userServerIPAddress').attr("disabled", true);
		$("input[name='server']").attr("disabled", true);
		connectToServer();
		this.disabled = true;
		});
  
	    $("#select-result").change(function(){
	        $('#btnCall').attr("disabled", (this.innerText == ""));
	    });
	    $("#selectable").selectable({
		stop: function() {
		  var result = $("#select-result" ).empty();
		  $( ".ui-selected", this ).each(function() {
		    var index = $( "#selectable li" ).index( this );
		    result.append(this.innerText);
		    result.change();
		  });
		}
	      });   
	    $('#btnCall').click(makeCall);
	    $('#pano').hide();
	    $('#map-canvas').hide();
	    $('#webRTCContacts').hide();
	    
	}
        
        function initializeStreetView(gps) {
	    $('#content-filler').hide();
	    $('#pano').show();
	    $('#map-canvas').show();
            
	    var view = new google.maps.LatLng(gps.lat, gps.long);
	    var mapOptions = {
		"center": view,
		"zoom": 15
	    };
	    map = new google.maps.Map(document.getElementById('map-canvas'), mapOptions);
            var panoramaOptions = {
              position: view,
              pov: {
                heading: 0,
                pitch: 0,
              }
            };
            panorama = new  google.maps.StreetViewPanorama(document.getElementById('pano'),panoramaOptions);
            map.setStreetView(panorama);
	    sendGPSSetMessageToPeer();
        }
        
        
        function updateStreetView(heading, pitch){
            console.log('updating street view to heading: ' + heading + ' with pitch ' + pitch);
            if (!panorama) {
                console.log('no streetview object to update - returning');
                return;
            }
            panorama.setPov({
			    heading: heading,
			    pitch:pitch});
	   
            
        }
	
	function enableConnectToServerButton(){
	    handleId = $('#userHandle').val();
	    var serverType = $("input[name='server']:checked").val();
	    var ec2 = $('#ec2ServerIPAddress').val();
	    var userDefined =  $('#userServerIPAddress').val()
	    serverIPAddress = (serverType == "ec2" ?  ec2 : userDefined);
	    var disabled = true;
	    if (handleId && handleId != "") {
	      if (serverIPAddress && serverIPAddress != "") {
		disabled = false;
	      }
	      
	    }
	    $('#btnConnect').attr("disabled", disabled);
	}
        
       window.addEventListener('load', init);
    </script>
</head>

<body>
    <div id="centerpoint">
	<div id="incoming-call">
	    <img id="call-img" src="img/call.jpg"/>
	    <span id="peer-information"></span>
	    <input type="button" id="butAnswerCall" value="Answer"/>			
	</div>
    </div>
    <div class="applicationContainer">
        <div id="connectBar">
            <span>
            <img src="img/pltlabslogo.jpg" />
            <span class="name">Wearables + WebRTC Concept<br><span class="user-name" id="user-name"></span></span>
            </span>
        </div>
	 <div id="sensorpane">
            <div id="sensortable">
                <table>
                    <thead>
                        <h3>Wanderlust has gotten the better of me...</h3>
                    </thead>
                    <tbody>
                        <tr>
                            <td>
				<div id="content-filler" style="width: 600px; background-size: cover; background-image: url('img/content-filler.png'); height: 400px">
				</div>
				<div id="pano" style="width: 600px; height: 400px;"></div>
			    </td>
                            <td width="300">
				<div id="webRTCConnection">
				<span>WebRTC Server:</span><br>
				 <span id="webrtcConnectedState">Not Connected</span><br>
				<input type="text" id="userHandle"><span> User Handle</span> <br><br>
				<input type="radio" name="server" id="server" value="user-defined"/><input id="userServerIPAddress" type="text" size="20" maxlength="15"><span> IP Address</span><br>
				<input type="radio" name="server" checked="checked" id="server" value="ec2"/><input id="ec2ServerIPAddress" type="text" readonly="readonly" size="20" maxlength="15" value="23.23.249.221"><span>PLTLabs Amazon EC2 Instance</span><br>
				<button id="btnConnect" disabled="disabled">Connect</button>
				</div>
				<div id="video-container">
				   <video id="remote-video" autoplay></video>
				</div>
				<div id="webRTCContacts">
				    <span>Call:</span> <span id="select-result"></span><span>  </span><input type="button" id="btnCall" disabled="disabled" value="Call For Help"/> <input type="button" id="btnHangUp" value="Hang Up"/><br>
                                    <br>
                                    <ul id="selectable">
                                    </ul>
                                    <button id="btnDisconnect">Disconnect</button>
				</div>
				<div id="map-canvas" style="width: 300px; height: 200px"></div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
     </div>
</body>
</html>
